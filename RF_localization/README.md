# RF Localization Code

### anchor_tag_stm32 is for flashing the anchor and tag boards, lora_server is for using the Wio-E5 to receive LoRa messages on the positioning computer. These folders contain more information about setting up software.

### Revisions were made to anchor pcb:

- Reset pin on the DW is now connected to the STM on pin 12
- Screen power mosfet deleted, screen is now powered through two GPIO pins on the STM
- JTAG pogo pin pads moved to the bottom side to make flashing easier when pcb is packaged in case
- 13k pulldown on the ILIM/VSET pin of the BQ instead of 18k to allow for 1.1A battery charge current instead of 0.5A
- 10k pulldown on the TS/MR pin of the BQ bypasses the thermal check to always charge when there is a 5V supply
- Charge diode deleted, originally intended to allow charging when switch is off, didn't work because BQ does voltage regulated charging

### Notes for anchor case assembly:

- The gerber files work for pcbway, layer stack is [SIG TOP, GND, PWR, SIG BOT], and are updated to rev. 2 of the anchor
- Screens are extremely delicate, use caution when pushing on the back because they will crack.
- Bend the button solder terminals 90deg then solder the button wire under them, otherwise the terminal will hit the anchor pcb
- The batteries ship with 2.54 JST, need to recrimp with PH 2.0

### Recommended future changes

- Use a fourth DW message from the anchor to the tag to transmit the calculated range to the tag. UWB transmit rate is much faster than LORA so you can log the position data on the MTAG SD card at a higher rate than the LORA server could receive.
- Change the STMF0 to a faster microcontroller, the DW SPI clock speed is currently 18MHz and this can be increased to at least 20MHz. We have seen forum posts where people have used up to 30MHz, so this is worth trying. (Look out for AndyA on the Decawave forums, he is the goat)
- Glass cover on the anchor case to prevent accidental screen damage
- Automatic anchor position calibration tool. We think the process for anchor calibration should be graphical, where the user proposes estimated anchor positions, then the tool optimizes the graph based on actual anchor-anchor ranges. Additionally, a calibration initialization message would have to be sent to the anchors, probably over LORA downlink to kick them into calibration mode. In calibration mode, the anchors should poll with a timeout then initialize TWR to the next higher anchor ID.
- For changing the STM to an ESP, we recommend modifying port.h to use the ESP HAL library, and deleting any STM autogenerated HAL includes. The other option is to use thotro/arduino-dw1000 library, which we have not tested.
